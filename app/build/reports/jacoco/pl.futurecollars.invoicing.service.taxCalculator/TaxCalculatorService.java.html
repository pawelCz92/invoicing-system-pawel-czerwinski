<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pl"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TaxCalculatorService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">app</a> &gt; <a href="index.source.html" class="el_package">pl.futurecollars.invoicing.service.taxcalculator</a> &gt; <span class="el_source">TaxCalculatorService.java</span></div><h1>TaxCalculatorService.java</h1><pre class="source lang-java linenums">package pl.futurecollars.invoicing.service.taxcalculator;

import java.math.BigDecimal;
import java.math.RoundingMode;
import java.util.Optional;
import java.util.function.Predicate;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import pl.futurecollars.invoicing.db.Database;
import pl.futurecollars.invoicing.model.Car;
import pl.futurecollars.invoicing.model.Company;
import pl.futurecollars.invoicing.model.Invoice;
import pl.futurecollars.invoicing.model.InvoiceEntry;

@RequiredArgsConstructor
@Service
public class TaxCalculatorService {

<span class="fc" id="L19">    private static final BigDecimal HEALTH_INSURANCE_PERCENT = BigDecimal.valueOf(9);</span>
<span class="fc" id="L20">    private static final BigDecimal MIN_PERCENT_TO_REDUCE_HEALTH_INSURANCE = BigDecimal.valueOf(7.75);</span>
<span class="fc" id="L21">    private static final BigDecimal PERCENT_TO_CALCULATE_INCOME_TAX = BigDecimal.valueOf(19);</span>
    private final Database database;

    private Predicate&lt;Invoice&gt; sellerPredicate(Company company) {
<span class="fc" id="L25">        return invoice -&gt; invoice.getSeller().getTaxIdentificationNumber().equals(company.getTaxIdentificationNumber());</span>
    }

    private Predicate&lt;Invoice&gt; buyerPredicate(Company company) {
<span class="fc" id="L29">        return invoice -&gt; invoice.getBuyer().getTaxIdentificationNumber().equals(company.getTaxIdentificationNumber());</span>
    }

    private BigDecimal income(Company company) {
<span class="fc" id="L33">        return database.visit(sellerPredicate(company), InvoiceEntry::getPrice);</span>
    }

    private BigDecimal costs(Company company) {
<span class="fc" id="L37">        return database.visit(buyerPredicate(company), this::getPriceIncludingPersonalExpense);</span>
    }

    private BigDecimal getPriceIncludingPersonalExpense(InvoiceEntry invoiceEntry) {
<span class="fc" id="L41">        return invoiceEntry.getPrice().add(invoiceEntry.getVatValue()).subtract(getVatValueIncludingPersonalExpense(invoiceEntry));</span>
    }

    private BigDecimal incomingVat(Company company) {
<span class="fc" id="L45">        return database.visit(sellerPredicate(company), InvoiceEntry::getVatValue);</span>
    }

    private BigDecimal outgoingVat(Company company) {
<span class="fc" id="L49">        return database.visit(buyerPredicate(company), this::getVatValueIncludingPersonalExpense);</span>
    }

    private BigDecimal getVatValueIncludingPersonalExpense(InvoiceEntry invoiceEntry) {
<span class="fc" id="L53">        return Optional.ofNullable(invoiceEntry.getCar())</span>
<span class="fc" id="L54">            .map(Car::isIncludingPrivateExpense)</span>
<span class="pc bnc" id="L55" title="All 2 branches missed.">            .map(privateExpense -&gt; privateExpense ? BigDecimal.valueOf(0.5) : BigDecimal.ONE)</span>
<span class="pc" id="L56">            .map(multiplier -&gt; invoiceEntry.getVatValue().multiply(multiplier))</span>
<span class="pc" id="L57">            .map(vatValue -&gt; vatValue.setScale(2, RoundingMode.HALF_DOWN))</span>
<span class="fc" id="L58">            .orElse(invoiceEntry.getVatValue());</span>
    }

    public TaxCalculatorResult calculateTaxes(Company company) {
<span class="fc" id="L62">        BigDecimal income = income(company);</span>
<span class="fc" id="L63">        BigDecimal costs = costs(company);</span>
<span class="fc" id="L64">        BigDecimal earnings = income.subtract(costs);</span>

<span class="fc" id="L66">        BigDecimal incomingVat = incomingVat(company);</span>
<span class="fc" id="L67">        BigDecimal outgoingVat = outgoingVat(company);</span>
<span class="fc" id="L68">        BigDecimal vatToReturn = incomingVat.subtract(outgoingVat);</span>

<span class="fc" id="L70">        BigDecimal earningsMinusPensionInsurance = earnings.subtract(company.getPensionInsurance());</span>
<span class="fc" id="L71">        BigDecimal taxCalculationBase = earningsMinusPensionInsurance.setScale(0, RoundingMode.HALF_UP);</span>
<span class="fc" id="L72">        BigDecimal incomeTax = taxCalculationBase.multiply(PERCENT_TO_CALCULATE_INCOME_TAX.divide(BigDecimal.valueOf(100)));</span>
<span class="fc" id="L73">        BigDecimal reducedHealthInsurance = reduceHealthInsurance(company.getHealthInsurance());</span>
<span class="fc" id="L74">        BigDecimal incomeTaxMinusHealthInsurance = incomeTax.subtract(reducedHealthInsurance);</span>
<span class="fc" id="L75">        BigDecimal finalIncomeTax = incomeTaxMinusHealthInsurance.setScale(0, RoundingMode.HALF_UP);</span>

<span class="fc" id="L77">        return TaxCalculatorResult.builder()</span>
<span class="fc" id="L78">            .income(income)</span>
<span class="fc" id="L79">            .costs(costs)</span>
<span class="fc" id="L80">            .earnings(earnings)</span>
<span class="fc" id="L81">            .incomingVat(incomingVat)</span>
<span class="fc" id="L82">            .outgoingVat(outgoingVat)</span>
<span class="fc" id="L83">            .vatToReturn(vatToReturn)</span>
<span class="fc" id="L84">            .earningsMinusPensionInsurance(earningsMinusPensionInsurance)</span>
<span class="fc" id="L85">            .taxCalculationBase(taxCalculationBase)</span>
<span class="fc" id="L86">            .incomeTax(incomeTax)</span>
<span class="fc" id="L87">            .reducedHealthInsurance(reducedHealthInsurance)</span>
<span class="fc" id="L88">            .incomeTaxMinusHealthInsurance(incomeTaxMinusHealthInsurance)</span>
<span class="fc" id="L89">            .pensionInsurance(company.getPensionInsurance())</span>
<span class="fc" id="L90">            .healthInsurance(company.getHealthInsurance())</span>
<span class="fc" id="L91">            .finalIncomeTax(finalIncomeTax)</span>
<span class="fc" id="L92">            .build();</span>
    }

    private BigDecimal reduceHealthInsurance(BigDecimal healthInsurance) {
<span class="fc" id="L96">        return healthInsurance</span>
<span class="fc" id="L97">            .divide(HEALTH_INSURANCE_PERCENT, 3, RoundingMode.HALF_UP)</span>
<span class="fc" id="L98">            .multiply(MIN_PERCENT_TO_REDUCE_HEALTH_INSURANCE)</span>
<span class="fc" id="L99">            .setScale(1, RoundingMode.HALF_UP);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>